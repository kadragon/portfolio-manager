{% extends "base.html" %}
{% block title %}리밸런싱 — 포트폴리오 매니저{% endblock %}

{% block content %}
<h2 class="page-header">리밸런싱 추천</h2>
<p class="page-subtitle">목표 비중 대비 과대/과소 상태를 기준으로 매매 권고를 표시합니다.</p>

{% if error %}
<div class="flash flash-error" role="alert" aria-live="polite">{{ error }}</div>
{% endif %}

{% if sell_recommendations %}
<section class="section-card">
  <h3><span class="badge badge-sell">매도</span> 추천</h3>
  <div class="table-wrap">
    <table class="table-compact">
      <thead>
        <tr>
          <th>그룹</th>
          <th>티커</th>
          <th>종목명</th>
          <th class="text-right">금액</th>
          <th class="text-right">수량</th>
          <th>통화</th>
        </tr>
      </thead>
      <tbody>
        {% for rec in sell_recommendations %}
        <tr>
          <td>{{ rec.group_name or "-" }}</td>
          <td><code>{{ rec.ticker }}</code></td>
          <td>{{ rec.stock_name or "-" }}</td>
          <td class="text-right value-negative">
            {% if rec.currency == "KRW" %}{{ rec.amount | format_krw }}{% else %}{{ rec.amount | format_usd }}{% endif %}
          </td>
          <td class="text-right">{% if rec.quantity is not none %}{{ rec.quantity | int }}{% else %}-{% endif %}</td>
          <td>{{ rec.currency or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% if buy_recommendations %}
<section class="section-card">
  <h3><span class="badge badge-buy">매수</span> 추천</h3>
  <div class="table-wrap">
    <table class="table-compact">
      <thead>
        <tr>
          <th>그룹</th>
          <th>티커</th>
          <th>종목명</th>
          <th class="text-right">금액</th>
          <th class="text-right">수량</th>
          <th>통화</th>
        </tr>
      </thead>
      <tbody>
        {% for rec in buy_recommendations %}
        <tr>
          <td>{{ rec.group_name or "-" }}</td>
          <td><code>{{ rec.ticker }}</code></td>
          <td>{{ rec.stock_name or "-" }}</td>
          <td class="text-right value-positive">
            {% if rec.currency == "KRW" %}{{ rec.amount | format_krw }}{% else %}{{ rec.amount | format_usd }}{% endif %}
          </td>
          <td class="text-right">{% if rec.quantity is not none %}{{ rec.quantity | int }}{% else %}-{% endif %}</td>
          <td>{{ rec.currency or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

{% if not sell_recommendations and not buy_recommendations and not error %}
<section class="section-card">
  <p>리밸런싱 추천이 없습니다. 현재 포트폴리오가 목표 비중에 가깝습니다.</p>
</section>
{% endif %}

{% if sell_recommendations or buy_recommendations %}
<div id="execute-result" class="section-card">
  <form hx-post="/rebalance/execute"
        hx-target="#execute-result"
        hx-swap="outerHTML"
        hx-confirm="실제 주문을 실행하시겠습니까?"
        data-request-message="주문을 실행하는 중…">
    {% if has_order_client %}
    <button type="submit" class="btn btn-primary">주문 실행</button>
    {% else %}
    <button type="button" class="btn" disabled title="KIS 주문 클라이언트가 설정되지 않았습니다.">주문 실행 불가 (KIS 미설정)</button>
    {% endif %}
  </form>
</div>
{% endif %}

<p><a href="/rebalance" class="btn btn-ghost">추천 다시 조회</a></p>
{% endblock %}
